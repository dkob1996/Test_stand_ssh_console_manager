# Оглавление

- [Суть программы](#0-суть-программыраздел-1)
- [A. Структура программы](#a-структура-программы)
- [B. Установленные и использующиеся пакеты](#b-установленные--использующиеся-пакеты)
- [C. Создание файла для логина по ssh](#c-создание-файла-для-логина-по-ssh)
- [D. Создание файла команд](#d-создание-файла-команд)
- [E. Сборка исполняемого файла для MAC](#e-сборка-исполняемого-файла-для-mac)
- [F. Сборка исполняемого файла для WIN](#f-сборка-исполняемого-файла-для-win)

## 0. Суть программы

Программа предназначена для удобного подключения пользователя к удаленному серверу по SSH для выполнении заранее определенных команд.<br>
В конкретном случе команда тестирования может подключаться к SSH серверу и выполнять команды на тестовых стендах:
- перезапуск стендов
- изменение настроек
- изменение визуального оформления
- просмотров логов celery, wsgi через cat, tail с возможностью grep
- запуска скриптов
<br>

Все это доступно с поддержкой интерактивного режима работы.

## A. Структура программы

### Файл: `main.py`
Основной файл программы. В нем инициализируются команды из файла `commands.yaml` и запускается CLI (интерфейс командной строки).

### Файл: `ssh_client.py`
Содержит класс `SSHClient`, который управляет SSH-соединением, включая методы для инициализации соединения, выполнения команд и завершения сессии.

#### Методы:
- `initialize()`: инициализирует SSH-клиент и устанавливает соединение.
- `close()`: закрывает SSH-соединение.
- `execute_command(command, prompt)`: выполняет команду в интерактивном режиме и обрабатывает вывод.

### Файл: `cli.py`
Содержит класс `CLI`, который управляет пользовательским интерфейсом командной строки. Он позволяет пользователю выбирать категории и команды, а затем выполняет команды с помощью SSH-клиента.

#### Методы:
- `load_login_data(file_path)`: загружает данные для подключения к SSH-серверу.
- `display_categories()`: выводит доступные категории.
- `display_commands(category)`: выводит команды для выбранной категории.
- `start()`: основной метод для запуска CLI и обработки ввода пользователя.

### Файл: `command_loader.py`
Содержит класс `CommandLoader`, который загружает команды из YAML-файла и создает их функции для выполнения в зависимости от выбранных параметров.

#### Методы:
- `load_commands(file_path)`: загружает команды и пути из YAML-файла и создает соответствующие команды для выполнения.

### Файл: `commands.yaml`
Файл конфигурации, который содержит пути и шаблоны команд для различных стендов. Он используется для генерации команд с подставленными параметрами.

### Файл: `login_data.yaml` (создавать отдельно)
Файл данных для подключения к серверу по ssh, который адрес, порт, логин, пароль.

## B. Установленные / использующиеся пакеты:
### Mac silicon
0. Открыть в терминале mac_silicon
```python
    cd mac_silicon
```
1. Надо войти в виртуальную среду
```python
    python3 -m venv myenv  
    source myenv/bin/activate  
```
2.  Установить пакеты
```python
    pip install paramiko
```
```python
    pip install pyyaml
```
3. Использующиеся пакеты
- paramiko: подключение по ssh
- sys: чтение данных от сервера на локальную машину и наоборот
- os: взаимодействие с состоянием локальной машины
- termios, tty, select: отправка данных из локальной машины
- logging: логгирование любых данных
- re: обрезка ненужных символов
- yaml: работа с файлами данных

---
### Windows 10/11 ARM64/x64
0. Открыть в терминале win_64
```python
    cd win_64
```
1. Надо войти в виртуальную среду через git bash
```python
    python -m venv myenv
    source myenv/Scripts/activate 
```
2.  Установить пакеты
```python
    pip install paramiko
```
```python
    pip install pyyaml
```
3. Использующиеся пакеты
```
Для windows мы не можем использовать termios, tty, select
Вместо них будем использовать msvcrt и shutil
```
- paramiko: подключение по ssh
- sys: чтение данных от сервера на локальную машину и наоборот
- os: взаимодействие с состоянием локальной машины
- msvcrt: отправка данных с клавиатуры
- shutil: определение разрешений окна программы
- logging: логгирование любых данных
- re: обрезка ненужных символов
- yaml: работа с файлами данных

## C. Создание файла для логина по ssh
0. В директории нет файла логина к серверу по ssh
1. Надо его создать в корне и назвать login_data.yaml
2. Занести в него данные:
```yaml
    hostname: "hostname"
    port: port
    username: "username"
    password: "password"
    postfix: "postfix"
```
- hostname: адрес сервера
- port: номер порта (стандартный = 22)
- username: имя пользователя
- password: пароль для входа
- postfix: то, что выводится в консоль после захода на сервер<br>
(например: username@<b>postfix</b>:~$)

Например:
```yaml
    hostname: "dev.google.app.com"
    port: 22
    username: "test"
    password: "easypass"
    postfix: "win-test123"
```

## D. Создание файла команд
0. В директории нет файла команд для сервера
1. Надо его создать в корне и назвать commands.yaml
2. Занести в него данные:<br>

Например:

```yaml
paths:
  logs: "/var/log/supervisor"
  base:
    standA: "~/standA/root"
    standB: "~/standB"

commands:
  deploy: "cd {src_path} && ../deploy.sh"
  change settings: "cd {src_path} && nano unegui/local_settings.py"
  change visual: "cd {base_path} && nano deploy.sh"
  restart celery: "cd {src_path} && supervisorctl restart celery_{stand}"
  full celery logs: "cd {src_path} && cat {logs_path}/celery_{stand}.log"
  full wsgi logs: "cd {src_path} && cat {logs_path}/wsgi_{stand}.log"
  tail celery logs: "cd {src_path} && tail -f {logs_path}/celery_{stand}.log"
  tail wsgi logs: "cd {src_path} && tail -f {logs_path}/wsgi_{stand}.log"
  run script: "cd {src_path} && source .venv/bin/activate && python manage.py "
```

## E. Сборка исполняемого файла для MAC
* Для тех у кого Mac
0. Перейти в папку
```python
cd mac_silicon
```
1. Уставнока пакета<br>
```python
    pip install pyinstaller
```

2. Выполнение команды по сборке<br>
```python
    pyinstaller --onefile --add-data "commands.yaml:." --add-data "login_data.yaml:." main.py    
```

2. В папке dist появляется исполняемый файл main
3. Его надо архивировать
4. Отправляем архив человеку с mac
5. Скачать архив
6. Распаковать
7. Открыть терминал
8. Выполнить:
```
    cd Downloads
```
9. Ввести для снятия защиты запуска на маке:
- потом файл можно перемещать в любую директорию
```
    xattr -cr main
```
10. После этого можно пользоваться

## F. Сборка исполняемого файла для WIN
* Для тех у кого Mac
* Если У вас Win, тогда можно использовать раздел E, однако команда по сборке должна быть из этого раздела

1. Устанавливаем UTM на Mac
- https://mac.getutm.app
2. Устанавливаем программу для скачки образа windows: Crystal Fetch (AppStore)
- https://apps.apple.com/kg/app/crystalfetch-iso-downloader/id6454431289?mt=12
3. Скачиваем ISO образ Win11 ARM64
```
Если собрать программу на Win11 ARM64, тогда есть совместимость с Win11/10 x64
```
- Открываем Crystal Fetch
- Выбираем Version: Windows 11 / Architecture: Apple Silicon
- Скачиваем
3. Запускаем виртуальную машину с Win11
- Будет просить активацию, можно воспользоваться 30-дневным пробным периодом
- Использовать гайд с сайта https://mac.getutm.app
4. Открываем наш проект
5. Устанавливаем python3
6. Переходим в директорию
```python
cd win_64
```
7. Устанавливаем pyintaller
8. Выполняем комманду через терминал
```python
pyinstaller --onefile --add-data "commands.yaml;." --add-data "login_data.yaml;." main.py
```
9. Берем файл main.exe из папки dist
10. Его надо архивировать
11. Отправляем архив человеку с mac
12. Скачать архив
13. Распаковать

### Трудности
Иногда бывают проблемы с python или виртуальной средой<br>
Вот способы решения:
1. Установили python, установили пакеты библиотек, а они подсвечиваются до сих пор желтым и не находятся?
```
Дело в том, что надо поправить путь до пайтона
```
Надо в path поменять путь
- Сначала заходит в любую папку, view - показать скрытые папки
- Либо в поиске по contol panel либо найти самому: system properties
- Если хотите найти по поиску - ищите по edit the system environment veriables
- Если вы нашли system properties в contol panel, тогда там вкладка Advanced
- И найдите там кнопку в самом низу environment veriables
- Там выбираем Path и edit
- Далее идем по такому пути примерно C:\Users\Имя_пользователя\AppData\Local\Packages\PythonSoftwareFoundation.Python.{версия_пайтон}\LocalCache\local_packages\Python313\Scripts
- Надо вот указать путь в котором последняя папку будет Scripts
---
2. На маке поднял виртуальный windows, поместил папку в с кодом в shared директорию, и при попытке запустить venv через папку открытую в shared есть ошибки
- Надо скопировать папку из общего хранилища в локальную директорию
- Установить Git
- Открыть через git bash папку win_64
- Запустить свое окружение
```python
python -m venv myenv
source myenv/Scripts/activate
```